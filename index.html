<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <title>C·∫•u h√¨nh ESP32</title>
  <style>
    body {
        font-family: sans-serif;
        /* padding: 10px 60px 100px 60px; */
        padding: 10px 10px 100px 10px;
        margin-top: 0;
        text-align: center;
        background: #f5f5f5;
      }

    #statusText.running {
      color: #2e7d32; /* Xanh ƒë·∫≠m n·ªïi b·∫≠t */
    }

    #statusText.stopped {
      color: #b71c1c; /* ƒê·ªè khi d·ª´ng */
    }

    .icon-indicator {
      font-size: 20px;
      margin-right: 6px;
      animation: blinkFire 1s infinite;
    }

    @keyframes blinkFire {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .input-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-top: 10px;
    }

    input[type="number"] {
      font-size: 20px;
      padding: 10px;
      width: 140px;
      text-align: center;
      border-radius: 8px;
      border: 2px solid #ccc;
    }

    .step-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .step-label {
      width: 70px;
      font-weight: bold;
      text-align: right;
    }

    .step-row input[type="number"] {
      width: 120px;
      padding: 6px 8px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      text-align: center;
    }

    button {
      padding: 8px 16px;
      font-size: 16px;
      border-radius: 6px;
      background-color: #4caf50;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 5px;
    }

    button:hover {
      background-color: #388e3c;
    }

    input.error {
      border-color: red;
    }

    #sentMsg {
      margin-top: 15px;
      color: green;
      font-weight: bold;
    }

    #confirmBox {
      display: none;
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 2px solid #ccc;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    #confirmBox button {
      min-width: 120px;
      padding: 8px 10px;
    }
    

    select, input[type="text"] {
      font-size: 16px;
      padding: 6px 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      border: 2px solid #ccc;
    }

    .control-panel {
      max-width: 600px;
      margin: auto;
      padding: 20px;
      background-color: #e0ebf5;
      border: 2px solid #6b90b7;
      border-radius: 10px;
      text-align: left;
    }

    .control-panel h3 {
      text-align: center;
      margin-top: 0;  /* kho·∫£ng c√°ch ph√≠a tr√™n */
      margin-bottom: 20px;
      font-size: 22px;
      color: #2c3e50;
    }

    .status-box {
      text-align: center;
      padding: 8px;
      border-radius: 5px;
      background-color: #d0e7ff;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .info-table {
      width: 100%;
      font-size: 16px;
      margin-bottom: 20px;
    }

    .info-table td {
      padding: 6px 10px;
      border-bottom: 1px dashed #ccc;
    }

    .info-table td:first-child {
      text-align: left;
      width: 50%;
    }

    .info-table td:last-child {
      text-align: right;  /* ‚úÖ Canh ph·∫£i n·ªôi dung gi√° tr·ªã */
      width: 50%;
      font-weight: bold;
    }


  .arrows {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 14px auto;

    margin-top: 4px !important;
    margin-bottom: 12px; /* kho·∫£ng c√°ch t·ªõi n√∫t CH·∫†Y/D·ª™NG */
  }
  .step-dropdown {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 10px;
  gap: 8px; /* üëà t·∫°o kho·∫£ng c√°ch gi·ªØa label v√† dropdown */
}

  .arrows button {
    display: flex;
    align-items: center;
    justify-content: center;

    font-size: 16px;
    width: 120px;
    height: 40px;
    background-color: #6b90b7;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    gap: 6px; /* kho·∫£ng c√°ch gi·ªØa icon v√† ch·ªØ */
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    transition: background-color 0.2s, transform 0.1s ease;
  }

  .arrows button:hover {
    background-color: #4a6d99;
    transform: scale(1.05);
  }

  .arrows button:active {
  transform: scale(0.95);
  background-color: #3e5c80;
}


    .run-stop {
      display: flex;
      justify-content: center;
      gap: 30px;
    }

    .run-stop button {
      width: 120px;
      padding: 10px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      font-weight: bold;
    }

    .run-stop .start {
      background-color: #c2f0b1;
      color: #1b5e20;
    }

    .run-stop .stop {
      background-color: #f7bdbd;
      color: #b71c1c;
    }

    .config-button-group {
      display: flex;
      flex-wrap: wrap;         /* cho responsive khi m√†n nh·ªè */
      justify-content: center; /* cƒÉn gi·ªØa */
      gap: 8px;                /* kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
      margin-top: 8px;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: white;
      border-top: 1px solid #ccc;
      padding: 10px 0;
      display: flex;
      justify-content: center;
      gap: 20px;
      z-index: 100;
    }



   @media (max-width: 600px) {
  .info-table {
    width: 100%;
  }

  .info-table tr {
    display: flex;
    justify-content: space-between;
    border-bottom: 1px dashed #ccc;
    padding: 6px 0;
  }

  .info-table td {
    display: inline-block;
    font-size: 16px; /* üëà tƒÉng size */
    padding: 4px 8px;
    white-space: nowrap;
    border: none;
  }

  .info-table td:first-child {
    text-align: left;
    font-weight: normal;
  }

  .info-table td:last-child {
    text-align: right;
    font-weight: bold;
  }
}



  </style>
</head>
<body>
  <h2>CH∆Ø∆†NG TR√åNH L√í NHI·ªÜT</h2>
<!-- Tabs content -->
  <div data-tab-content="dieukhien">
    <div class="control-panel">
      <h3>ƒêi·ªÅu Khi·ªÉn L√≤ Nhi·ªát</h3>

      <div class="status-box">
        <span style="margin-right: 8px;">Tr·∫°ng th√°i:</span>
        <span id="statusIndicator" class="icon-indicator">üî¥</span>
        <strong id="statusText">ƒêANG D·ª™NG</strong>
      </div>

      <table class="info-table">
        <tr><td>üìÑ T√™n file:</td><td><strong id="selectedFileName">...</strong></td></tr>
        <tr><td>üî• Nhi·ªát ƒë·ªô th·ª±c:</td><td><strong  id="realtimeTemp">0¬∞C</strong></td></tr>
        <tr><td>üå°Ô∏è Nhi·ªát ƒë·ªô c√†i:</td><td><strong id="realtimeTempSV">0¬∞C</strong></td></tr>
        <tr><td>üìâ B∆∞·ªõc nhi·ªát:</td><td><strong id="stepNumber">1</strong></td></tr>
        <tr><td>‚è±Ô∏è Th·ªùi gian b∆∞·ªõc:</td><td><strong id="stepTime">...</strong></td></tr>
        <tr><td>‚è±Ô∏è TG b∆∞·ªõc ƒë√£ ch·∫°y:</td><td><strong id="stepElapsed">...</strong></td></tr>
        <tr><td>üïí T·ªïng TG d·ª± ki·∫øn:</td><td><strong id="totalExpected">...</strong></td></tr>
        <tr><td>üßÆ T·ªïng TG ƒë√£ ch·∫°y:</td><td><strong id="totalElapsed">...</strong></td></tr>
        <tr><td>‚ö†Ô∏è C·∫£nh b√°o:</td><td><strong  id="alertText">Kh√¥ng c√≥</strong></td></tr>
      </table>


      <div class="step-dropdown" style="text-align: center; margin-bottom: 10px;">
        <label for="stepSelect"><strong>üìå Ch·ªçn ch∆∞∆°ng tr√¨nh:</strong></label>
        <select id="stepSelect" style="font-size:16px; padding:6px 12px; border-radius:6px; margin-left:10px; border:1px solid #aaa;">
          <!-- Option s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JS -->
        </select>
      </div>


      <div class="arrows">
        <button id="step-up">üîº TƒÉng b∆∞·ªõc</button>
        <button id="step-down">üîΩ Gi·∫£m b∆∞·ªõc</button>
      </div>

      <div class="run-stop">
        <button class="start">‚ñ∂Ô∏è CH·∫†Y</button>
        <button class="stop">‚õî D·ª™NG</button>
      </div>
    </div>
  </div>


  <div data-tab-content="cauhinh" style="display:none">
  <label for="fileSelect">Ch·ªçn file c·∫•u h√¨nh:</label>
  <select id="fileSelect">
    <option value="0">üìÅ File 1</option>
    <option value="1">üìÅ File 2</option>
    <option value="2">üìÅ File 3</option>
    <option value="3">üìÅ File 4</option>
    <option value="4">üìÅ File 5</option>
  </select>

  <br />
  <input type="text" id="fileName" placeholder="üî§ ƒê·ªïi t√™n file..." />
  <br />
  <div class="config-button-group">
    <button id="renameBtn">üíæ ƒê·ªïi t√™n file</button>
    <button id="saveBtn">üíæ L∆∞u c√†i ƒë·∫∑t</button>
    <button id="loadBtn">üîÑ Load c·∫•u h√¨nh</button>
  </div>

  <div class="input-group" id="configInputs">
  <!-- 8 b∆∞·ªõc g·ªìm Nhi·ªát ƒë·ªô v√† Th·ªùi gian -->
  <div class="step-row">
    <span class="step-label">B∆∞·ªõc 1</span>
    <input type="number" id="T1" placeholder="Nhi·ªát ƒë·ªô"  min="0" max="1300" step="1" />
    <input type="number" id="D1" placeholder="Th·ªùi gian"  min="0" max="1300" step="1" />
  </div>
  <div class="step-row">
    <span class="step-label">B∆∞·ªõc 2</span>
    <input type="number" id="T2" placeholder="Nhi·ªát ƒë·ªô" min="0" max="1300" step="1" />
    <input type="number" id="D2" placeholder="Th·ªùi gian"  min="0" max="1300" step="1" />
  </div>
  <div class="step-row">
    <span class="step-label">B∆∞·ªõc 3</span>
    <input type="number" id="T3" placeholder="Nhi·ªát ƒë·ªô"  min="0" max="1300" step="1" />
    <input type="number" id="D3" placeholder="Th·ªùi gian"  min="0" max="1300" step="1" />
  </div>
  <div class="step-row">
    <span class="step-label">B∆∞·ªõc 4</span>
   <input type="number" id="T4" placeholder="Nhi·ªát ƒë·ªô"  min="0" max="1300" step="1" />
    <input type="number" id="D4" placeholder="Th·ªùi gian" min="0" max="1300" step="1" />
  </div>
  <div class="step-row">
    <span class="step-label">B∆∞·ªõc 5</span>
   <input type="number" id="T5" placeholder="Nhi·ªát ƒë·ªô"  min="0" max="1300" step="1" />
    <input type="number" id="D5" placeholder="Th·ªùi gian"  min="0" max="1300" step="1" />
  </div>
  <div class="step-row">
    <span class="step-label">B∆∞·ªõc 6</span>
   <input type="number" id="T6" placeholder="Nhi·ªát ƒë·ªô"  min="0" max="1300" step="1" />
    <input type="number" id="D6" placeholder="Th·ªùi gian"  min="0" max="1300" step="1" />
  </div>
  <div class="step-row">
    <span class="step-label">B∆∞·ªõc 7</span>
    <input type="number" id="T7" placeholder="Nhi·ªát ƒë·ªô"  min="0" max="1300" step="1" />
    <input type="number" id="D7" placeholder="Th·ªùi gian" min="0" max="1300" step="1" />
  </div>
  <div class="step-row">
    <span class="step-label">B∆∞·ªõc 8</span>
    <input type="number" id="T8" placeholder="Nhi·ªát ƒë·ªô" min="0" max="1300" step="1" />
    <input type="number" id="D8" placeholder="Th·ªùi gian"  min="0" max="1300" step="1" />
  </div>
</div>

  <div id="sentMsg"></div>

  <div id="confirmBox">
    <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u c√†i ƒë·∫∑t?</p>
    <button id="confirmYes">‚úÖ C√≥</button>
    <button id="confirmNo">‚ùå Kh√¥ng</button>
  </div>
</div>

<!-- Thanh tab c·ªë ƒë·ªãnh ·ªü ch√¢n trang -->
<footer style="position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ccc; padding: 10px 0; display: flex; justify-content: center; gap: 20px; z-index: 1000;">
  <button data-tab="dieukhien">üß≠ ƒêi·ªÅu khi·ªÉn</button>
  <button data-tab="cauhinh">‚öôÔ∏è C·∫•u h√¨nh</button>
</footer>

  <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
  <script>
    let fileLabels = []; // ch·ªâ khai b√°o 1 l·∫ßn ·ªü ƒë·∫ßu
    
    // const fields = ["A", "B", "C", "D", "E"];

        const fields = [
      "T1", "D1", "T2", "D2", "T3", "D3", "T4", "D4",
      "T5", "D5", "T6", "D6", "T7", "D7", "T8", "D8"
    ];
    const inputs = fields.map(id => document.getElementById(id));
    const fileSelect = document.getElementById("fileSelect");
    const fileNameInput = document.getElementById("fileName");
    const renameBtn = document.getElementById("renameBtn");
    const saveBtn = document.getElementById("saveBtn");
    const loadBtn = document.getElementById("loadBtn");
    const sentMsg = document.getElementById("sentMsg");

    const confirmBox = document.getElementById("confirmBox");
    const confirmYes = document.getElementById("confirmYes");
    const confirmNo = document.getElementById("confirmNo");

    const tempPV = document.getElementById('realtimeTemp');  // Ph·∫ßn t·ª≠ hi·ªÉn th·ªã nhi·ªát ƒë·ªô
    const tempSV = document.getElementById('realtimeTempSV');  // Ph·∫ßn t·ª≠ hi·ªÉn th·ªã nhi·ªát ƒë·ªô

    let isEditing = false;
    let editTimer = null;
    let actionFile1 = null, actionFile2 = null, actionFile3 = null, actionFile4 = null, actionFile5 = null;
    let actionRename1 = null, actionRename2 = null, actionRename3 = null, actionRename4 = null, actionRename5 = null;
    let configNameFile1 = null, configNameFile2 = null, configNameFile3 = null, configNameFile4 = null, configNameFile5 = null;
    let configValueFile1 = null, configValueFile2 = null, configValueFile3 = null, configValueFile4 = null, configValueFile5 = null;
    let actionLoadFile1 = null, actionLoadFile2 = null;
    let configND = 0, configSV = 0, configReadPrg = null;
    let selectFileRUN = null, statusL = null, timechay = null, runStop = null, btnTangGiam = null, buochay = null;
    let currentValues = {};
    let manualStep = 1;

    document.querySelectorAll("[data-tab]").forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");
        document.querySelectorAll("[data-tab-content]").forEach(div => {
          div.style.display = div.getAttribute("data-tab-content") === tab ? "block" : "none";
        });
      });
    });

    window.addEventListener("DOMContentLoaded", () => {
      // L·∫•y ch·ªâ s·ªë v√† t√™n file t·ª´ localStorage
      const lastSelectedFile = localStorage.getItem("lastSelectedFile");
      const fileNames = JSON.parse(localStorage.getItem("fileNames") || "[]");

      // Kh√¥i ph·ª•c t√™n file t·ª´ localStorage cho dropdown
      const fileSelect = document.getElementById("fileSelect");

      if (lastSelectedFile !== null) {
        fileSelect.selectedIndex = lastSelectedFile; // ƒê·∫∑t l·∫°i ch·ªâ s·ªë c·ªßa dropdown
      }

      // Kh√¥i ph·ª•c t√™n file hi·ªÉn th·ªã trong "ƒêi·ªÅu khi·ªÉn"
      const selectedFileName = fileNames[lastSelectedFile] || fileSelect.options[lastSelectedFile].text.replace("üìÅ ", "");
      document.getElementById("selectedFileName").innerText = selectedFileName;
    });

    const eraWidget = new EraWidget();
    
    eraWidget.init({
      needActions: true,
      needConfigs: true,
      mobileHeight: 930,

      onConfiguration: (config) => {
        
        configNameFile1 = config.realtime_configs[0];
        configNameFile2 = config.realtime_configs[1];
        configNameFile3 = config.realtime_configs[2];
        configNameFile4 = config.realtime_configs[3];
        configNameFile5 = config.realtime_configs[4];

        configValueFile1 = config.realtime_configs[5];
        configValueFile2 = config.realtime_configs[6];
        configValueFile3 = config.realtime_configs[7];
        configValueFile4 = config.realtime_configs[8];
        configValueFile5 = config.realtime_configs[9];

        configND = config.realtime_configs[10];
        configSV = config.realtime_configs[11];

        configReadPrg = config.realtime_configs[12];
        statusL = config.realtime_configs[13];
        timechay = config.realtime_configs[14];

        actionFile1 = config.actions[0];
        actionFile2 = config.actions[1];
        actionFile3 = config.actions[2];
        actionFile4 = config.actions[3];
        actionFile5 = config.actions[4];

        actionRename1 = config.actions[5];
        actionRename2 = config.actions[6];
        actionRename3 = config.actions[7];
        actionRename4 = config.actions[8];
        actionRename5 = config.actions[9];

        actionLoadFile1 = config.actions[10];
        actionLoadFile2 = config.actions[11];
        actionLoadFile3 = config.actions[12];
        actionLoadFile4 = config.actions[13];
        actionLoadFile5 = config.actions[14];

        selectFileRUN = config.actions[15];
        runStop = config.actions[16];
        btnTangGiam = config.actions[17];

        fileSelect.dispatchEvent(new Event("change"));
        // T·ª± ƒë·ªông trigger load c·∫•u h√¨nh
        setTimeout(() => {
          const loadActions = [
            actionLoadFile1,
            actionLoadFile2,
            actionLoadFile3,
            actionLoadFile4,
            actionLoadFile5
          ];

          const loadAction = loadActions[lastIdx];
          if (loadAction) {
            eraWidget.triggerAction(loadAction.action, null, { value: "__load__" });
            fileSelect.dispatchEvent(new Event("change"));
          }
        }, 1500);
      },
      onValues: (values) => {
        currentValues = values;

        


        const valueTempPV = values[configND.id].value;
        const valueTempSV = values[configSV.id].value;
        const valueFilePRG = values[configReadPrg.id].value;
        const stLoDien = values[statusL.id].value;
        const sttimechay =  values[timechay.id].value;

        // 1. C·∫≠p nh·∫≠t nhi·ªát ƒë·ªô
        tempPV.innerHTML = !isNaN(valueTempPV) ? Math.round(valueTempPV) + ' ¬∞C' : '...';
        tempSV.innerHTML = !isNaN(valueTempSV) ? Math.round(valueTempSV) + ' ¬∞C' : '...';

        // 2. Tr·∫°ng th√°i + c·∫£nh b√°o
        const [status, alert1] = stLoDien.split(",");
        const statusTextEl = document.getElementById("statusText");
        const statusIndicator = document.getElementById("statusIndicator");

        if (statusTextEl && statusIndicator) {
          if (status === "1") {
            statusTextEl.textContent = "ƒêANG CH·∫†Y";
            statusTextEl.classList.remove("stopped");
            statusTextEl.classList.add("running");
            statusIndicator.classList.add("icon-indicator");
            statusIndicator.textContent = "üî•";
          } else {
            statusTextEl.textContent = "ƒêANG D·ª™NG";
            statusTextEl.classList.remove("running");
            statusTextEl.classList.add("stopped");
            statusIndicator.classList.remove("icon-indicator");
            statusIndicator.textContent = "üî¥";
          }
        }

        const alertBox = document.getElementById("alertText");
        let alertText = "Kh√¥ng c√≥ c·∫£nh b√°o";
        if (alert1 === "1") alertText = "B·∫•t th∆∞·ªùng";
        else if (alert1 === "2") alertText = "L·ªói (lo·∫°i 1)";
        else if (alert1 === "3") alertText = "L·ªói (lo·∫°i 2)";
        if (alertBox) alertBox.innerHTML = `<strong>${alertText}</strong>`;

        // 3. C·∫≠p nh·∫≠t dropdown #stepSelect (tab ƒëi·ªÅu khi·ªÉn)
        const configNameFiles = [
          configNameFile1, configNameFile2, configNameFile3,
          configNameFile4, configNameFile5
        ];
        
        if (sttimechay) {
          const parts = sttimechay.split(",");
          if (parts.length === 5) {
            const [stbuochay, timeMin, stepElapsed, totalExpect, totalElapsed] = parts;
            document.getElementById("stepNumber").innerText = stbuochay || "...";
            document.getElementById("stepTime").innerText = timeMin ? `${timeMin} ph√∫t` : "...";
            document.getElementById("stepElapsed").innerText = stepElapsed ? `${stepElapsed} ph√∫t` : "...";
            document.getElementById("totalExpected").innerText = totalExpect || "...";
            document.getElementById("totalElapsed").innerText = totalElapsed || "...";
          }
        }

////////////////
// ‚úÖ B√¢y gi·ªù m·ªõi d√πng ƒë∆∞·ª£c v√¨ bi·∫øn ƒë√£ t·ªìn t·∫°i

///////////////



        updateStepSelectDropdown(configNameFiles, values, valueFilePRG);

        // 4. C·∫≠p nh·∫≠t dropdown #fileSelect (tab c·∫•u h√¨nh)
        const fileSelect = document.getElementById("fileSelect");
        
        // Danh s√°ch label m·ªõi
        const fileLabels = configNameFiles.map((cfg, i) => {
          if (!cfg || !values[cfg.id]) return `üìÅ File ${i + 1}`;
          let val = values[cfg.id].value;
          try {
            val = typeof val === 'string' ? JSON.parse(val) : val;
          } catch {}
          const label = val?.confirmed || val?.name || `File ${i + 1}`;
          return `üìÅ ${label}`;
        });

        // C·∫≠p nh·∫≠t dropdown n·∫øu th·ª±c s·ª± thay ƒë·ªïi
        updateDropdownIfChanged(fileSelect, fileLabels);

        // Kh√¥i ph·ª•c file ƒë∆∞·ª£c ch·ªçn tr∆∞·ªõc ƒë√≥ (ch·ªâ s·ªë)
        const lastIdx = parseInt(localStorage.getItem("lastSelectedFile") || "0");
        if (lastIdx >= 0 && lastIdx < fileSelect.options.length) {
          fileSelect.value = lastIdx.toString();
        }

        // 5. C·∫≠p nh·∫≠t √¥ nh·∫≠p li·ªáu t·ª´ file ƒë√£ ch·ªçn ·ªü tab c·∫•u h√¨nh
        const configValues = [
          configValueFile1, configValueFile2, configValueFile3,
          configValueFile4, configValueFile5
        ];
        const selectedIdx = parseInt(fileSelect.value);
        const configValue = configValues[selectedIdx];
        updateInputsFromConfig(configValue);
      }
    });
    let isUpdatingFromConfig = false;

    function updateInputsFromConfig(configValue) {
      if (isEditing) return;  // ‚õî ƒêang ch·ªânh tay, kh√¥ng c·∫≠p nh·∫≠t

      if (!configValue || !currentValues[configValue.id]) return;
      const raw = currentValues[configValue.id].value;
      try {
        const parsed = typeof raw === 'string' ? JSON.parse(raw) : raw;
        if (parsed && typeof parsed === 'object') {
          fields.forEach(id => {
            if (parsed[id] !== undefined) {
              document.getElementById(id).value = parsed[id];
            }
          });
        }
      } catch (e) {
        console.error("‚ùå Kh√¥ng th·ªÉ parse d·ªØ li·ªáu c·∫•u h√¨nh:", e);
      }
    }



    // L·∫Øng nghe s·ª± ki·ªán khi ng∆∞·ªùi d√πng ch·ªçn ch∆∞∆°ng tr√¨nh t·ª´ dropdown trong tab "ƒêi·ªÅu khi·ªÉn"
    document.getElementById("stepSelect").addEventListener("change", () => {
      const idx = parseInt(document.getElementById("stepSelect").value);  // L·∫•y gi√° tr·ªã index c·ªßa ch∆∞∆°ng tr√¨nh ƒë√£ ch·ªçn

      // C·∫≠p nh·∫≠t t√™n ch∆∞∆°ng tr√¨nh hi·ªÉn th·ªã b√™n khu "ƒêi·ªÅu khi·ªÉn"
      const selectedOption = document.getElementById("stepSelect").options[idx];
      document.getElementById("selectedFileName").innerText = selectedOption.text.replace("üìÅ ", "");

      // G·ª≠i gi√° tr·ªã action t∆∞∆°ng ·ª©ng v·ªõi ch·ªâ s·ªë file (1 cho File 1, 2 cho File 2,...)
      const actionValue = idx;  // actionValue l√† 1 cho File 1, 2 cho File 2, v.v.

      // G·ª≠i action t·ªõi ESP32 (selectFileRUN l√† action b·∫°n ƒë√£ x√°c ƒë·ªãnh)
      if (selectFileRUN) {
        eraWidget.triggerAction(selectFileRUN.action, null, { value: actionValue });
      }

      // C·∫≠p nh·∫≠t √¥ nh·∫≠p li·ªáu t·ª´ c·∫•u h√¨nh c·ªßa file ƒë√£ ch·ªçn
      const configValue = [configValueFile1, configValueFile2, configValueFile3, configValueFile4, configValueFile5][idx];
      updateInputsFromConfig(configValue);
    });


    renameBtn.addEventListener("click", () => {
      const name = fileNameInput.value.trim();
      const idx = parseInt(fileSelect.value);
      if (!name) return;

      // C·∫≠p nh·∫≠t t√™n hi·ªÉn th·ªã trong dropdown
      fileSelect.options[idx].text = `üìÅ ${name}`;
      document.getElementById("selectedFileName").innerText = name;

      // Reset input
      fileNameInput.value = "";

      // G·ª≠i action ƒë·ªïi t√™n l√™n ESP
      const renameActions = [actionRename1, actionRename2, actionRename3, actionRename4, actionRename5];
      const renameAction = renameActions[idx];
      if (renameAction) {
        const payload = { value: { index: idx, name } };
        eraWidget.triggerAction(renameAction.action, null, payload);
        sentMsg.innerText = `üì§ ƒê√£ g·ª≠i y√™u c·∫ßu ƒë·ªïi t√™n File ${idx + 1} ‚Üí "${name}"`;
        setTimeout(() => sentMsg.innerText = "", 3000);
      }
    });


    saveBtn.addEventListener("click", () => {
      confirmBox.style.display = "block";
    });

    confirmNo.addEventListener("click", () => {
      confirmBox.style.display = "none";
    });

    confirmYes.addEventListener("click", () => {
      confirmBox.style.display = "none";
      sendConfig();
    });

    loadBtn.addEventListener("click", () => {
      const idx = parseInt(fileSelect.value);
      const loadAction = [actionLoadFile1, actionLoadFile2, actionLoadFile3, actionLoadFile4, actionLoadFile5][idx];
      if (!loadAction) return;

      eraWidget.triggerAction(loadAction.action, null, { value: "__load__" });
      sentMsg.innerText = `üì• ƒê√£ y√™u c·∫ßu ESP32 g·ª≠i l·∫°i c·∫•u h√¨nh File ${idx + 1}`;
      setTimeout(() => sentMsg.innerText = "", 2000);
    });

    const allInputs = document.querySelectorAll('input[type="number"]');

    allInputs.forEach(input => {
      input.addEventListener("input", () => {
        let val = input.value;
        if (val === "") return;

        // √âp v·ªÅ s·ªë nguy√™n kh√¥ng √¢m
        let intVal = parseInt(val);
        if (isNaN(intVal) || intVal < 0) intVal = 0;
        if (intVal > 1300) intVal = 1300;

        input.value = intVal;  // C·∫≠p nh·∫≠t l·∫°i input
      });

      // N·∫øu ƒë·ªÉ tr·ªëng v√† chuy·ªÉn focus th√¨ tr·∫£ v·ªÅ 0
      input.addEventListener("blur", () => {
        if (input.value.trim() === "") {
          input.value = "0";
        }
      });
    });

// G√°n s·ª± ki·ªán ch·ªâ 1 l·∫ßn khi load web
inputs.forEach(input => {
  input.addEventListener("input", () => {
    isEditing = true;
    if (editTimer) clearTimeout(editTimer);
    editTimer = setTimeout(() => {
      isEditing = false;  // Sau 3 gi√¢y kh√¥ng nh·∫≠p n·ªØa m·ªõi cho c·∫≠p nh·∫≠t l·∫°i
    }, 3000);
  });
});



    function sendConfig() {
      const data = {};
      let valid = true;

      inputs.forEach(input => {
        const val = input.value.trim();
        if (/^-?\d+$/.test(val)) {
          data[input.id] = parseInt(val);
          input.classList.remove("error");
        } else {
          input.classList.add("error");
          valid = false;
        }
      });

      if (!valid) return;

      const idx = parseInt(fileSelect.value);
      const selectedAction = [actionFile1, actionFile2, actionFile3, actionFile4, actionFile5][idx];
      if (!selectedAction) return;

      eraWidget.triggerAction(selectedAction.action, null, { value: data });
      sentMsg.innerText = `‚úÖ ƒê√£ g·ª≠i c·∫•u h√¨nh t·ªõi File ${idx + 1}`;
      // ‚úÖ Sau khi l∆∞u ‚Üí t·ª± load l·∫°i t·ª´ ESP
      setTimeout(() => {

      // Ki·ªÉm tra xem idx c√≥ h·ª£p l·ªá kh√¥ng
        if (idx < 0 || idx >= 5) {
            console.error("Index kh√¥ng h·ª£p l·ªá: ", idx);
            return;
        }
        const configValue = [configValueFile1, configValueFile2, configValueFile3, configValueFile4, configValueFile5][idx];
        updateInputsFromConfig(configValue);
      }, 2000);
    }

    // L·∫Øng nghe s·ª± ki·ªán khi ng∆∞·ªùi d√πng ch·ªçn ch∆∞∆°ng tr√¨nh t·ª´ dropdown trong tab "ƒêi·ªÅu khi·ªÉn"
  document.getElementById("stepSelect").addEventListener("change", () => {
  const idx = parseInt(document.getElementById("stepSelect").value);  // L·∫•y gi√° tr·ªã index c·ªßa ch∆∞∆°ng tr√¨nh ƒë√£ ch·ªçn

  // C·∫≠p nh·∫≠t t√™n ch∆∞∆°ng tr√¨nh hi·ªÉn th·ªã b√™n khu "ƒêi·ªÅu khi·ªÉn"
  const selectedOption = document.getElementById("stepSelect").options[idx];
  document.getElementById("selectedFileName").innerText = selectedOption.text.replace("üìÅ ", "");

  // Kh√¥ng thay ƒë·ªïi gi√° tr·ªã c·ªßa dropdown "Ch·ªçn file c·∫•u h√¨nh" trong tab "C·∫•u h√¨nh"
  // V·∫´n gi·ªØ nguy√™n gi√° tr·ªã ƒë√£ ch·ªçn trong dropdown c·ªßa "C·∫•u h√¨nh"
  });

    // L·∫Øng nghe s·ª± ki·ªán khi ng∆∞·ªùi d√πng thay ƒë·ªïi file trong dropdown "Ch·ªçn file c·∫•u h√¨nh"
    fileSelect.addEventListener("change", () => {
      const idx = parseInt(fileSelect.value);  // L·∫•y ch·ªâ s·ªë c·ªßa file ƒë√£ ch·ªçn

      // C·∫≠p nh·∫≠t t√™n file hi·ªÉn th·ªã b√™n khu "ƒêi·ªÅu khi·ªÉn"
      const selectedOption = fileSelect.options[idx];
      document.getElementById("selectedFileName").innerText = selectedOption.text.replace("üìÅ ", "");

      // L∆∞u ch·ªâ s·ªë v√† t√™n file v√†o localStorage
      localStorage.setItem("lastSelectedFile", idx);  // L∆∞u ch·ªâ s·ªë c·ªßa file ƒë√£ ch·ªçn v√†o localStorage
      localStorage.setItem("lastSelectedFileName", selectedOption.text.replace("üìÅ ", ""));  // L∆∞u t√™n file v√†o localStorage

      // C·∫≠p nh·∫≠t √¥ nh·∫≠p li·ªáu t·ª´ c·∫•u h√¨nh c·ªßa file ƒë√£ ch·ªçn
      const configValue = [configValueFile1, configValueFile2, configValueFile3, configValueFile4, configValueFile5][idx];
      updateInputsFromConfig(configValue);
    });


    function updateStepSelectDropdown(configNameFiles, values, currentIndex) {
      const stepSelect = document.getElementById("stepSelect");

      const newOptions = configNameFiles.map((cfg, i) => {
        if (!cfg || !values[cfg.id]) return `üìÅ File ${i + 1}`;
        let val = values[cfg.id].value;
        try {
          val = typeof val === 'string' ? JSON.parse(val) : val;
        } catch {}
        return `üìÅ ${val?.confirmed || val?.name || `File ${i + 1}`}`;
      });

      const currentOptions = Array.from(stepSelect.options).map(opt => opt.text.trim());
      const same = newOptions.length === currentOptions.length &&
                  newOptions.every((txt, i) => txt === currentOptions[i]);

      // N·∫øu kh√°c th√¨ c·∫≠p nh·∫≠t l·∫°i dropdown
      if (!same) {
        const currentValue = stepSelect.value;
        stepSelect.innerHTML = "";
        newOptions.forEach((text, i) => {
          const opt = document.createElement("option");
          opt.value = i.toString();
          opt.text = text;
          stepSelect.appendChild(opt);
        });

        // Kh√¥i ph·ª•c l·ª±a ch·ªçn n·∫øu c√≤n t·ªìn t·∫°i
        if ([...stepSelect.options].some(opt => opt.value === currentValue)) {
          stepSelect.value = currentValue;
        }
      }

      // ‚úÖ Lu√¥n ƒë·ªìng b·ªô tr·∫°ng th√°i theo ch·ªâ s·ªë ESP g·ª≠i (ngay c·∫£ khi dropdown kh√¥ng ƒë·ªïi)
      if (currentIndex >= 0 && currentIndex < stepSelect.options.length) {
        stepSelect.value = currentIndex.toString();
        document.getElementById("selectedFileName").innerText =
          stepSelect.options[currentIndex].text.replace(/üìÅ\s*/, "");
      }
    }


    function updateDropdownIfChanged(selectEl, newOptions) {
      const currentOptions = Array.from(selectEl.options).map(opt => opt.text.trim().replace("üìÅ ", ""));
      const cleanedNewOptions = newOptions.map(opt => opt.trim().replace("üìÅ ", ""));

      const same = cleanedNewOptions.length === currentOptions.length &&
                  cleanedNewOptions.every((txt, i) => txt === currentOptions[i]);

      if (same) return; // Kh√¥ng c·∫ßn c·∫≠p nh·∫≠t

      const currentValue = selectEl.value; // ‚úÖ Ghi nh·ªõ gi√° tr·ªã ƒëang ch·ªçn

      selectEl.innerHTML = ""; // X√≥a h·∫øt option c≈©
      newOptions.forEach((text, i) => {
        const opt = document.createElement("option");
        opt.value = i.toString();
        opt.text = text;
        selectEl.appendChild(opt);
      });

      // ‚úÖ Kh√¥i ph·ª•c l·∫°i l·ª±a ch·ªçn ƒëang ch·ªçn (n·∫øu c√≤n t·ªìn t·∫°i)
      if ([...selectEl.options].some(opt => opt.value === currentValue)) {
        selectEl.value = currentValue;
      }
    }


    // G√°n s·ª± ki·ªán CH·∫†Y/D·ª™NG
    document.querySelector(".run-stop .start").addEventListener("click", () => {
      if (runStop) {
        eraWidget.triggerAction(runStop.action, null, { value: 1 });
      }
    });

    document.querySelector(".run-stop .stop").addEventListener("click", () => {
      if (runStop) {
        eraWidget.triggerAction(runStop.action, null, { value: 0 });
      }
    });

    //s·ª± ki·ªán nh·∫•n n√∫t tƒÉng gi·∫£m

    document.getElementById("step-up").addEventListener("click", () => {
      if (btnTangGiam) {
        eraWidget.triggerAction(btnTangGiam.action, null, { value: 1 });  // G·ª≠i l·ªánh tƒÉng l√™n ESP32 qua V25
        console.log("üîº ƒê√£ g·ª≠i y√™u c·∫ßu tƒÉng b∆∞·ªõc nhi·ªát");
      }
    });

    document.getElementById("step-down").addEventListener("click", () => {
      if (btnTangGiam) {
        eraWidget.triggerAction(btnTangGiam.action, null, { value: -1 });  // G·ª≠i l·ªánh gi·∫£m xu·ªëng ESP32 qua V25
        console.log("üîΩ ƒê√£ g·ª≠i y√™u c·∫ßu gi·∫£m b∆∞·ªõc nhi·ªát");
      }
    });
  </script>
</body>

</html>
